/* single-spa-layout@1.6.0 - umd */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("parse5/lib/tree-adapters/default.js"),require("path"),require("fs"),require("single-spa"),require("parse5/lib/parser/index.js"),require("parse5/lib/common/html.js"),require("parse5/lib/common/doctype.js"),require("stream"),require("merge2")):"function"==typeof define&&define.amd?define(["exports","parse5/lib/tree-adapters/default.js","path","fs","single-spa","parse5/lib/parser/index.js","parse5/lib/common/html.js","parse5/lib/common/doctype.js","stream","merge2"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).singleSpaLayout={},e.defaultTreeAdapter,e.path,e.fs,e.singleSpa,e.Parser,e.HTML,e.doctype,e.stream,e.merge2)}(this,(function(e,t,r,o,n,a,s,i,l,d){"use strict";function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function c(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var o=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,o.get?o:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var p=u(t),f=u(r),m=u(o),h=c(n),g=u(a),y=u(s),N=u(i),b=u(d);const E=Object.assign({},p.default,{isElementNode:e=>p.default.isElementNode(e)||e.type&&!e.type.startsWith("#"),getChildNodes:e=>p.default.getChildNodes(e)||e.routes,getTagName:e=>p.default.getTagName(e)||e.type,isCommentNode:e=>p.default.isCommentNode(e)||"#comment"===e.type,isTextNode:e=>p.default.isTextNode(e)||"#text"===e.type,getCommentNodeContent:e=>p.default.getCommentNodeContent(e)||e.value}),w="undefined"!=typeof window;function v(e,t){if("object"!=typeof t||Array.isArray(t)||null===t)throw Error(`Invalid ${e}: received ${Array.isArray(t)?"array":t} but expected a plain object`)}function P(e,t){if("boolean"!=typeof t)throw Error(`Invalid ${e}: received ${typeof t}, but expected a boolean`)}function T(e,t,r,o){if(o)return;const n=Object.keys(t),a=[];n.forEach((e=>{r.indexOf(e)<0&&a.push(e)})),a.length>0&&console.warn(Error(`Invalid ${e}: received invalid properties '${a.join(", ")}', but valid properties are ${r.join(", ")}`))}function O(e,t,r=!0){if("string"!=typeof t||r&&""===t.trim())throw Error(`Invalid ${e}: received '${t}', but expected a${r?" non-blank":""} string`)}function $(e,t){if(O(e,t),t.indexOf("/")<0)throw Error(`Invalid ${e}: received '${t}', but expected an absolute path that starts with /`)}function S(e,t,r,...o){if(!Array.isArray(t)&&("object"!=typeof typeof t||"number"!==t.length))throw Error(`Invalid ${e}: received '${t}', but expected an array`);for(let n=0;n<t.length;n++)r(t[n],`${e}[${n}]`,...o)}function A(e,t){O("path",t);const r={...e},o=e.base.slice(0,e.base.length-1);if(0===t.indexOf(o)){const o=w?window.location.origin:"http://localhost",n=new URL(x(o,t));r.routes=C(n,e.routes)}else r.routes=[];return r}function C(e,t){const r=[];return t.forEach((t=>{"application"===t.type?r.push(t):"route"===t.type?t.activeWhen(e)&&r.push({...t,routes:C(e,t.routes)}):Array.isArray(t.routes)?r.push({...t,routes:C(e,t.routes)}):r.push(t)})),r}function x(e,t){let r;return r="/"===e.substr(-1)?"/"===t[0]?e+t.slice(1):e+t:"/"===t[0]?e+t:e+"/"+t,"/"===r.substr(-1)&&r.length>1&&(r=r.slice(0,r.length-1)),r}const L=Object.prototype.hasOwnProperty.call(h,"default")?Object.getOwnPropertyDescriptor(h,"default").value.pathToActiveWhen:h.pathToActiveWhen,j="undefined"!=typeof Symbol?Symbol():"@";function M(e,t){if(w)return e.getAttribute(t);{const r=function(e,t){for(let r=0;r<e.length;r++)if(t(e[r]))return e[r];return null}(e.attrs,(e=>e.name===t.toLowerCase()));return r?r.value:null}}function R(e,t){return w?e.hasAttribute(t):e.attrs.some((e=>e.name===t))}function D(e,t,r){if("application"===e.nodeName.toLowerCase()){if(e.childNodes.length>0)throw Error("<application> elements must not have childNodes. You must put in a closing </application> - self closing is not allowed");const r={type:"application",name:M(e,"name")},o=M(e,"loader");if(o)if(t.loaders&&t.loaders.hasOwnProperty(o))r.loader=t.loaders[o];else if(w)throw Error(`Application loader '${o}' was not defined in the htmlLayoutData`);const n=M(e,"error");if(n)if(t.errors&&t.errors.hasOwnProperty(n))r.error=t.errors[n];else if(w)throw Error(`Application error handler '${o}' was not defined in the htmlLayoutData`);return I(e,r,t),[r]}if("route"===e.nodeName.toLowerCase()){const o={type:"route",routes:[]},n=M(e,"path");n&&(o.path=n),R(e,"default")&&(o.default=!0),R(e,"exact")&&(o.exact=!0),I(e,o,t);for(let n=0;n<e.childNodes.length;n++)o.routes.push(...D(e.childNodes[n],t,r));return[o]}if("redirect"===e.nodeName.toLowerCase())return r.redirects[x("/",M(e,"from"))]=x("/",M(e,"to")),[];if("undefined"!=typeof Node&&e instanceof Node){if(e.nodeType===Node.TEXT_NODE&&""===e.textContent.trim())return[];if(e.childNodes&&e.childNodes.length>0){e.routes=[];for(let o=0;o<e.childNodes.length;o++)e.routes.push(...D(e.childNodes[o],t,r))}return[e]}if(e.childNodes){const o={type:e.nodeName.toLowerCase(),routes:[],attrs:e.attrs};for(let n=0;n<e.childNodes.length;n++)o.routes.push(...D(e.childNodes[n],t,r));return[o]}return"#comment"===e.nodeName?[{type:"#comment",value:e.data}]:"#text"===e.nodeName?[{type:"#text",value:e.value}]:void 0}function I(e,t,r){const o=(M(e,"props")||"").split(",");for(let e=0;e<o.length;e++){const n=o[e].trim();if(0!==n.length)if(t.props||(t.props={}),r.props&&r.props.hasOwnProperty(n))t.props[n]=r.props[n];else{if(w)throw Error(`Prop '${n}' was not defined in the htmlLayoutData. Either remove this attribute from the HTML element or provide the prop's value`);t.props[n]=j}}}class W extends g.default{_processToken(e){if("IN_HEAD_MODE"!==this.insertionMode||"START_TAG_TOKEN"!==e.type||"fragment"!==e.tagName&&"assets"!==e.tagName)return super._processToken(e);this._appendElement(e,y.default.NAMESPACES.HTML),e.ackSelfClosing=!0}}const H="single-spa-layout (server):";function _(e,t){const r=q(e,t);if(r)return r;throw Error(`${H} could not find ${t} element in HTML`)}function q(e,t){const r=E.getTagName(e),o="template"===r?E.getChildNodes(E.getTemplateContent(e)):E.getChildNodes(e);if(r===t)return e;if(o)for(let e=0;e<o.length;e++){const r=q(o[e],t);if(r)return r}return null}const k=y.default.TAG_NAMES,F=y.default.NAMESPACES,B=/&/g,U=/\u00a0/g,X=/"/g,G=/</g,K=/>/g;function z(e){const{node:t,inRouterElement:r}=e;let o=E.getChildNodes(t);for(let t=0;t<o.length;t++){let n,a=o[t];if(a._originalNode&&(a=a._originalNode),!r&&Y(a)?n=V:!r&&J(a)?n=Q:ee(a)?n=te:oe(a)?n=ae:re(a)?n=ne:E.isElementNode(a)?n=se:E.isTextNode(a)?n=ie:E.isCommentNode(a)?n=de:E.isDocumentTypeNode(a)&&(n=ue),!n)throw console.error(a),Error(`Unable to serialize node ${a.nodeName||a.nodeType||a.type}`);n({...e,node:a})}}function Y(e){return"application"===E.getTagName(e)}function J(e){return"route"===E.getTagName(e)}function Q(e){z({...e,node:e.node})}function V({node:e,assetsStream:t,bodyStream:r,renderOptions:o,applicationPropPromises:n,propPromises:a,headerPromises:s}){const i=e.name,l=e.props||{},d=Promise.all(Object.keys(l).map((e=>{let t;return t=l[e]===j?a[e]||(a[e]=o.retrieveProp(e)):l[e],Promise.resolve(t).then((t=>[e,t]))}))).then((e=>{const t={};return e.forEach((([e,r])=>{t[e]=r})),t.name=i,t}));let u,c,p;n[i]=d,s[i]=o.retrieveApplicationHeaders({appName:i,propsPromise:d});try{if(u=o.renderApplication({appName:i,propsPromise:d}),"function"==typeof u.then)c=b.default(),p=b.default(),u.then((e=>{const t=Z(i,e);c.add(t.contentStream),p.add(t.assetStream)}),(e=>{c.add(fe(i,e)),p.add(fe(i,e))}));else{const e=Z(i,u);c=e.contentStream,p=e.assetStream}}catch(e){c=fe(i,e),p=fe(i,e)}t.add(p),r.add(ce(`<div id="single-spa-application:${i}">`)),r.add(c),r.add(ce("</div>"))}function Z(e,t){let r,o;return t?(r=pe(t.content||t,e),o=pe(t.assets||"",e)):(r=fe(e,Error("returned nothing")),o=fe(e,Error("returned nothing"))),{contentStream:r,assetStream:o}}function ee(e){return E.isElementNode(e)&&"ssl-router-content"===E.getTagName(e)}function te(e){const{renderOptions:t}=e,r=A(t.serverLayout.resolvedRoutes,t.urlPath);z({...e,node:{childNodes:r.routes}}),function({propPromises:e,bodyStream:t}){try{t.add(pe((async()=>{const t=(await Promise.all(Object.entries(e).map((([e,t])=>t.then((t=>[e,t])))))).reduce(((e,[t,r])=>(e[t]=r,e)),{});return`<script>window.singleSpaLayoutData = ${JSON.stringify({props:t})}<\/script>`})()))}catch(e){t.add(fe("Serialize layout props",e))}}(e)}function re(e){return E.isElementNode(e)&&"fragment"===E.getTagName(e)}function oe(e){return E.isElementNode(e)&&"assets"===E.getTagName(e)}function ne({node:e,bodyStream:t,renderOptions:r}){const o=E.getAttrList(e).find((e=>"name"===e.name));if(!o.name)throw Error("<fragment> has unknown name");let n;try{n=pe(r.renderFragment(o.value),`Fragment ${o.value}`)}catch(e){n=fe(`Fragment ${o.name}`,e)}t.add(n)}function ae({assetsStream:e,bodyStream:t}){t.add(e)}function se(e){const{node:t,bodyStream:r}=e,o=E.getTagName(t),n=E.getNamespaceURI(t);if(r.add(ce(`<${o}`)),function({node:e,bodyStream:t}){const r=E.getAttrList(e)||[];for(let e=0,o=r.length;e<o;e++){const o=r[e],n=le(o.value,!0);let a;o.namespace?o.namespace===F.XML?a="xml:"+o.name:o.namespace===F.XMLNS?("xmlns"!==o.name&&(a="xmlns:"),a=o.name):a=o.namespace===F.XLINK?"xlink:"+o.name:o.prefix+":"+o.name:a=o.name,t.add(ce(` ${a}="${n}"`))}}(e),r.add(ce(">")),o!==k.AREA&&o!==k.BASE&&o!==k.BASEFONT&&o!==k.BGSOUND&&o!==k.BR&&o!==k.COL&&o!==k.EMBED&&o!==k.FRAME&&o!==k.HR&&o!==k.IMG&&o!==k.INPUT&&o!==k.KEYGEN&&o!==k.LINK&&o!==k.META&&o!==k.PARAM&&o!==k.SOURCE&&o!==k.TRACK&&o!==k.WBR){const a=o===k.TEMPLATE&&n===F.HTML?E.getTemplateContent(t):t,s=e.inRouterElement||"single-spa-router"===o;z({...e,node:a,inRouterElement:s}),r.add(ce(`</${o}>`))}}function ie({node:e,bodyStream:t}){const r=E.getTextNodeContent(e),o=E.getParentNode(e);let n=null;o&&E.isElementNode(o)&&(n=E.getTagName(o)),n===k.STYLE||n===k.SCRIPT||n===k.XMP||n===k.IFRAME||n===k.NOEMBED||n===k.NOFRAMES||n===k.PLAINTEXT||n===k.NOSCRIPT?t.add(ce(r)):t.add(ce(le(r,!1)))}function le(e,t){return e=e.replace(B,"&amp;").replace(U,"&nbsp;"),t?e.replace(X,"&quot;"):e.replace(G,"&lt;").replace(K,"&gt;")}function de({node:e,bodyStream:t}){t.add(ce(`\x3c!--${E.getCommentNodeContent(e)}--\x3e`))}function ue({node:e,bodyStream:t}){const r=E.getDocumentTypeNodeName(e);t.add(ce(`<${N.default.serializeContent(r,null,null)}>`))}function ce(e){const t=new l.Readable({read(){}});return t.push(e),t.push(null),t}function pe(e,t){let r;if(e&&"function"==typeof e.then){const o=e;r=b.default(),o.then((e=>{r.add("string"==typeof e?ce(e):e)}),(e=>{r.add(fe(t,e))}))}else r="string"==typeof e?ce(e):e;return r}function fe(e,t){return console.error(`${e} failed to render.`),console.error(t),ce("")}e.constructServerLayout=function(e){if(!e)throw Error(`${H} templateOptions is required`);let t,r;if(e.hasOwnProperty("html"))t=e.html,O("html",t);else{if(!e.hasOwnProperty("filePath"))throw Error(`${H} either templateOptions.html or templateOptions.filePath is required`);t=m.default.readFileSync(f.default.resolve(process.cwd(),e.filePath),"utf-8").toString(),O("filePath",t)}const o=new W;try{r=o.parse(t)}catch(e){throw console.error(`${H} failed to parse HTML template with parse5.`),e}const n=function(e,t){if(e&&e.nodeName||"string"==typeof e){if(w&&!t&&window.singleSpaLayoutData&&(t=window.singleSpaLayoutData),"string"==typeof e){if(!w)throw Error("calling constructRoutes with a string on the server is not yet supported");if(!(e=(new DOMParser).parseFromString(e,"text/html").documentElement.querySelector("single-spa-router")))throw Error("constructRoutes should be called with a string HTML document that contains a <single-spa-router> element.")}e=function(e,t={}){if("template"===e.nodeName.toLowerCase()&&(e=(e.content||e).querySelector("single-spa-router")),"single-spa-router"!==e.nodeName.toLowerCase())throw Error(`single-spa-layout: The HTMLElement passed to constructRoutes must be <single-spa-router> or a <template> containing the router. Received ${e.nodeName}`);w&&e.isConnected&&e.parentNode.removeChild(e);const r={routes:[],redirects:{}};M(e,"mode")&&(r.mode=M(e,"mode")),M(e,"base")&&(r.base=M(e,"base")),M(e,"containerEl")&&(r.containerEl=M(e,"containerEl"));for(let o=0;o<e.childNodes.length;o++)r.routes.push(...D(e.childNodes[o],t,r));return r}(e,t)}else if(t)throw Error("constructRoutes should be called either with an HTMLElement and layoutData, or a single json object.");return function(e){v("routesConfig",e);const t=e.disableWarnings;var r;if(T("routesConfig",e,["mode","base","containerEl","routes","disableWarnings","redirects"],t),e.hasOwnProperty("containerEl")?function(e,t){let r;if(r="string"==typeof t?""===t.trim():!(w&&t instanceof HTMLElement),r)throw Error(`Invalid routesConfig.containerEl: received ${t} but expected either non-blank string or HTMLElement`)}(0,e.containerEl):e.containerEl="body",e.hasOwnProperty("mode")||(e.mode="history"),function(e,t,r){if(r.indexOf(t)<0)throw Error(`Invalid routesConfig.mode: received '${t}' but expected ${r.join(", ")}`)}(0,e.mode,["history","hash"]),e.hasOwnProperty("base")?(O("routesConfig.base",e.base),e.base=(0!==(r=e.base).indexOf("/")&&(r="/"+r),"/"!==r[r.length-1]&&(r+="/"),r)):e.base="/",e.hasOwnProperty("redirects")){v("routesConfig.redirects",e.redirects);for(let t in e.redirects){const r=e.redirects[t];$("routesConfig.redirects key",t),$(`routesConfig.redirects['${t}']`,r)}}const o=w?window.location.pathname:"/",n="hash"===e.mode?o+"#":"";S("routesConfig.routes",e.routes,(function e(r,o,{parentPath:n,siblingActiveWhens:a,parentActiveWhen:s}){if(v(o,r),"application"===r.type)T(o,r,["type","name","props","loader","error"],t),r.props&&v(`${o}.props`,r.props),O(`${o}.name`,r.name);else if("route"===r.type){T(o,r,["type","path","routes","props","default","exact"],t),r.hasOwnProperty("exact")&&P(`${o}.exact`,r.exact);const i=r.hasOwnProperty("path"),l=r.hasOwnProperty("default");let d;if(i)O(`${o}.path`,r.path),d=x(n,r.path),r.activeWhen=L(d,r.exact),a.push(r.activeWhen);else{if(!l)throw Error(`Invalid ${o}: routes must have either a path or default property.`);P(`${o}.default`,r.default),d=n,r.activeWhen=function(e,t){return r=>t(r)&&!e.some((e=>e(r)))}(a,s)}if(i&&l&&r.default)throw Error(`Invalid ${o}: cannot have both path and set default to true.`);r.routes&&S(`${o}.routes`,r.routes,e,{parentPath:d,siblingActiveWhens:[],parentActiveWhen:r.activeWhen})}else{if("undefined"!=typeof Node&&r instanceof Node);else for(let e in r)"routes"!==e&&"attrs"!==e&&O(`${o}['${e}']`,r[e],!1);r.routes&&S(`${o}.routes`,r.routes,e,{parentPath:n,siblingActiveWhens:a,parentActiveWhen:s})}}),{parentPath:n+e.base,parentActiveWhen:()=>!0,siblingActiveWhens:[]}),delete e.disableWarnings}(e),e}(_(r,"single-spa-router"));let a=n.containerEl;"string"==typeof a&&(a=_(r,a));const s=E.createElement("ssl-router-content",null,[]),i=E.getFirstChild(a);return i?E.insertBefore(a,s,i):E.appendChild(a,s),{parsedDocument:r,resolvedRoutes:n}},e.sendLayoutHTTPResponse=async function(e){if(!e)throw Error("single-spa-layout (server): must provide renderOptions");const t=e.serverLayout.resolvedRoutes.redirects;for(let r in t){const o=t[r];if(e.urlPath===r)return void e.res.redirect(o)}const r={},o={},n=b.default({pipeError:!0}),a=b.default({pipeError:!0});z({node:e.serverLayout.parsedDocument,assetsStream:n,bodyStream:a,renderOptions:e,propPromises:{},applicationPropPromises:r,headerPromises:o,inRouterElement:!1});const s=await Promise.all(Object.keys(o).map((async e=>{const[t,n]=await Promise.all([o[e],r[e]]);return{appHeaders:t,appProps:n}}))),i=e.assembleFinalHeaders(s);for(let t in i)e.res.setHeader(t,i[t]);a.pipe(e.res)},Object.defineProperty(e,"__esModule",{value:!0})}));
