/* single-spa-layout@1.6.0 - esm */
import e from"parse5/lib/tree-adapters/default.js";import t from"path";import r from"fs";import*as o from"single-spa";import n from"parse5/lib/parser/index.js";import a from"parse5/lib/common/html.js";import s from"parse5/lib/common/doctype.js";import{Readable as i}from"stream";import l from"merge2";const d=Object.assign({},e,{isElementNode:t=>e.isElementNode(t)||t.type&&!t.type.startsWith("#"),getChildNodes:t=>e.getChildNodes(t)||t.routes,getTagName:t=>e.getTagName(t)||t.type,isCommentNode:t=>e.isCommentNode(t)||"#comment"===t.type,isTextNode:t=>e.isTextNode(t)||"#text"===t.type,getCommentNodeContent:t=>e.getCommentNodeContent(t)||t.value}),p="undefined"!=typeof window;function c(e,t){if("object"!=typeof t||Array.isArray(t)||null===t)throw Error(`Invalid ${e}: received ${Array.isArray(t)?"array":t} but expected a plain object`)}function u(e,t){if("boolean"!=typeof t)throw Error(`Invalid ${e}: received ${typeof t}, but expected a boolean`)}function m(e,t,r,o){if(o)return;const n=Object.keys(t),a=[];n.forEach((e=>{r.indexOf(e)<0&&a.push(e)})),a.length>0&&console.warn(Error(`Invalid ${e}: received invalid properties '${a.join(", ")}', but valid properties are ${r.join(", ")}`))}function f(e,t,r=!0){if("string"!=typeof t||r&&""===t.trim())throw Error(`Invalid ${e}: received '${t}', but expected a${r?" non-blank":""} string`)}function h(e,t){if(f(e,t),t.indexOf("/")<0)throw Error(`Invalid ${e}: received '${t}', but expected an absolute path that starts with /`)}function g(e,t,r,...o){if(!Array.isArray(t)&&("object"!=typeof typeof t||"number"!==t.length))throw Error(`Invalid ${e}: received '${t}', but expected an array`);for(let n=0;n<t.length;n++)r(t[n],`${e}[${n}]`,...o)}function y(e,t){f("path",t);const r={...e},o=e.base.slice(0,e.base.length-1);if(0===t.indexOf(o)){const o=p?window.location.origin:"http://localhost",n=new URL(E(o,t));r.routes=N(n,e.routes)}else r.routes=[];return r}function N(e,t){const r=[];return t.forEach((t=>{"application"===t.type?r.push(t):"route"===t.type?t.activeWhen(e)&&r.push({...t,routes:N(e,t.routes)}):Array.isArray(t.routes)?r.push({...t,routes:N(e,t.routes)}):r.push(t)})),r}function E(e,t){let r;return r="/"===e.substr(-1)?"/"===t[0]?e+t.slice(1):e+t:"/"===t[0]?e+t:e+"/"+t,"/"===r.substr(-1)&&r.length>1&&(r=r.slice(0,r.length-1)),r}const w=Object.prototype.hasOwnProperty.call(o,"default")?Object.getOwnPropertyDescriptor(o,"default").value.pathToActiveWhen:o.pathToActiveWhen,b="undefined"!=typeof Symbol?Symbol():"@";function v(e,t){if(p)return e.getAttribute(t);{const r=function(e,t){for(let r=0;r<e.length;r++)if(t(e[r]))return e[r];return null}(e.attrs,(e=>e.name===t.toLowerCase()));return r?r.value:null}}function P(e,t){return p?e.hasAttribute(t):e.attrs.some((e=>e.name===t))}function T(e,t,r){if("application"===e.nodeName.toLowerCase()){if(e.childNodes.length>0)throw Error("<application> elements must not have childNodes. You must put in a closing </application> - self closing is not allowed");const r={type:"application",name:v(e,"name")},o=v(e,"loader");if(o)if(t.loaders&&t.loaders.hasOwnProperty(o))r.loader=t.loaders[o];else if(p)throw Error(`Application loader '${o}' was not defined in the htmlLayoutData`);const n=v(e,"error");if(n)if(t.errors&&t.errors.hasOwnProperty(n))r.error=t.errors[n];else if(p)throw Error(`Application error handler '${o}' was not defined in the htmlLayoutData`);return $(e,r,t),[r]}if("route"===e.nodeName.toLowerCase()){const o={type:"route",routes:[]},n=v(e,"path");n&&(o.path=n),P(e,"default")&&(o.default=!0),P(e,"exact")&&(o.exact=!0),$(e,o,t);for(let n=0;n<e.childNodes.length;n++)o.routes.push(...T(e.childNodes[n],t,r));return[o]}if("redirect"===e.nodeName.toLowerCase())return r.redirects[E("/",v(e,"from"))]=E("/",v(e,"to")),[];if("undefined"!=typeof Node&&e instanceof Node){if(e.nodeType===Node.TEXT_NODE&&""===e.textContent.trim())return[];if(e.childNodes&&e.childNodes.length>0){e.routes=[];for(let o=0;o<e.childNodes.length;o++)e.routes.push(...T(e.childNodes[o],t,r))}return[e]}if(e.childNodes){const o={type:e.nodeName.toLowerCase(),routes:[],attrs:e.attrs};for(let n=0;n<e.childNodes.length;n++)o.routes.push(...T(e.childNodes[n],t,r));return[o]}return"#comment"===e.nodeName?[{type:"#comment",value:e.data}]:"#text"===e.nodeName?[{type:"#text",value:e.value}]:void 0}function $(e,t,r){const o=(v(e,"props")||"").split(",");for(let e=0;e<o.length;e++){const n=o[e].trim();if(0!==n.length)if(t.props||(t.props={}),r.props&&r.props.hasOwnProperty(n))t.props[n]=r.props[n];else{if(p)throw Error(`Prop '${n}' was not defined in the htmlLayoutData. Either remove this attribute from the HTML element or provide the prop's value`);t.props[n]=b}}}class A extends n{_processToken(e){if("IN_HEAD_MODE"!==this.insertionMode||"START_TAG_TOKEN"!==e.type||"fragment"!==e.tagName&&"assets"!==e.tagName)return super._processToken(e);this._appendElement(e,a.NAMESPACES.HTML),e.ackSelfClosing=!0}}const C="single-spa-layout (server):";function S(e){if(!e)throw Error(`${C} templateOptions is required`);let o,n;if(e.hasOwnProperty("html"))o=e.html,f("html",o);else{if(!e.hasOwnProperty("filePath"))throw Error(`${C} either templateOptions.html or templateOptions.filePath is required`);o=r.readFileSync(t.resolve(process.cwd(),e.filePath),"utf-8").toString(),f("filePath",o)}const a=new A;try{n=a.parse(o)}catch(e){throw console.error(`${C} failed to parse HTML template with parse5.`),e}const s=function(e,t){if(e&&e.nodeName||"string"==typeof e){if(p&&!t&&window.singleSpaLayoutData&&(t=window.singleSpaLayoutData),"string"==typeof e){if(!p)throw Error("calling constructRoutes with a string on the server is not yet supported");if(!(e=(new DOMParser).parseFromString(e,"text/html").documentElement.querySelector("single-spa-router")))throw Error("constructRoutes should be called with a string HTML document that contains a <single-spa-router> element.")}e=function(e,t={}){if("template"===e.nodeName.toLowerCase()&&(e=(e.content||e).querySelector("single-spa-router")),"single-spa-router"!==e.nodeName.toLowerCase())throw Error(`single-spa-layout: The HTMLElement passed to constructRoutes must be <single-spa-router> or a <template> containing the router. Received ${e.nodeName}`);p&&e.isConnected&&e.parentNode.removeChild(e);const r={routes:[],redirects:{}};v(e,"mode")&&(r.mode=v(e,"mode")),v(e,"base")&&(r.base=v(e,"base")),v(e,"containerEl")&&(r.containerEl=v(e,"containerEl"));for(let o=0;o<e.childNodes.length;o++)r.routes.push(...T(e.childNodes[o],t,r));return r}(e,t)}else if(t)throw Error("constructRoutes should be called either with an HTMLElement and layoutData, or a single json object.");return function(e){c("routesConfig",e);const t=e.disableWarnings;var r;if(m("routesConfig",e,["mode","base","containerEl","routes","disableWarnings","redirects"],t),e.hasOwnProperty("containerEl")?function(e,t){let r;if(r="string"==typeof t?""===t.trim():!(p&&t instanceof HTMLElement),r)throw Error(`Invalid routesConfig.containerEl: received ${t} but expected either non-blank string or HTMLElement`)}(0,e.containerEl):e.containerEl="body",e.hasOwnProperty("mode")||(e.mode="history"),function(e,t,r){if(r.indexOf(t)<0)throw Error(`Invalid routesConfig.mode: received '${t}' but expected ${r.join(", ")}`)}(0,e.mode,["history","hash"]),e.hasOwnProperty("base")?(f("routesConfig.base",e.base),e.base=(0!==(r=e.base).indexOf("/")&&(r="/"+r),"/"!==r[r.length-1]&&(r+="/"),r)):e.base="/",e.hasOwnProperty("redirects")){c("routesConfig.redirects",e.redirects);for(let t in e.redirects){const r=e.redirects[t];h("routesConfig.redirects key",t),h(`routesConfig.redirects['${t}']`,r)}}const o=p?window.location.pathname:"/",n="hash"===e.mode?o+"#":"";g("routesConfig.routes",e.routes,(function e(r,o,{parentPath:n,siblingActiveWhens:a,parentActiveWhen:s}){if(c(o,r),"application"===r.type)m(o,r,["type","name","props","loader","error"],t),r.props&&c(`${o}.props`,r.props),f(`${o}.name`,r.name);else if("route"===r.type){m(o,r,["type","path","routes","props","default","exact"],t),r.hasOwnProperty("exact")&&u(`${o}.exact`,r.exact);const i=r.hasOwnProperty("path"),l=r.hasOwnProperty("default");let d;if(i)f(`${o}.path`,r.path),d=E(n,r.path),r.activeWhen=w(d,r.exact),a.push(r.activeWhen);else{if(!l)throw Error(`Invalid ${o}: routes must have either a path or default property.`);u(`${o}.default`,r.default),d=n,r.activeWhen=function(e,t){return r=>t(r)&&!e.some((e=>e(r)))}(a,s)}if(i&&l&&r.default)throw Error(`Invalid ${o}: cannot have both path and set default to true.`);r.routes&&g(`${o}.routes`,r.routes,e,{parentPath:d,siblingActiveWhens:[],parentActiveWhen:r.activeWhen})}else{if("undefined"!=typeof Node&&r instanceof Node);else for(let e in r)"routes"!==e&&"attrs"!==e&&f(`${o}['${e}']`,r[e],!1);r.routes&&g(`${o}.routes`,r.routes,e,{parentPath:n,siblingActiveWhens:a,parentActiveWhen:s})}}),{parentPath:n+e.base,parentActiveWhen:()=>!0,siblingActiveWhens:[]}),delete e.disableWarnings}(e),e}(O(n,"single-spa-router"));let i=s.containerEl;"string"==typeof i&&(i=O(n,i));const l=d.createElement("ssl-router-content",null,[]),y=d.getFirstChild(i);return y?d.insertBefore(i,l,y):d.appendChild(i,l),{parsedDocument:n,resolvedRoutes:s}}function O(e,t){const r=x(e,t);if(r)return r;throw Error(`${C} could not find ${t} element in HTML`)}function x(e,t){const r=d.getTagName(e),o="template"===r?d.getChildNodes(d.getTemplateContent(e)):d.getChildNodes(e);if(r===t)return e;if(o)for(let e=0;e<o.length;e++){const r=x(o[e],t);if(r)return r}return null}const L=a.TAG_NAMES,M=a.NAMESPACES,R=/&/g,I=/\u00a0/g,W=/"/g,j=/</g,D=/>/g;async function H(e){if(!e)throw Error("single-spa-layout (server): must provide renderOptions");const t=e.serverLayout.resolvedRoutes.redirects;for(let r in t){const o=t[r];if(e.urlPath===r)return void e.res.redirect(o)}const r={},o={},n=l({pipeError:!0}),a=l({pipeError:!0});k({node:e.serverLayout.parsedDocument,assetsStream:n,bodyStream:a,renderOptions:e,propPromises:{},applicationPropPromises:r,headerPromises:o,inRouterElement:!1});const s=await Promise.all(Object.keys(o).map((async e=>{const[t,n]=await Promise.all([o[e],r[e]]);return{appHeaders:t,appProps:n}}))),i=e.assembleFinalHeaders(s);for(let t in i)e.res.setHeader(t,i[t]);a.pipe(e.res)}function k(e){const{node:t,inRouterElement:r}=e;let o=d.getChildNodes(t);for(let t=0;t<o.length;t++){let n,a=o[t];if(a._originalNode&&(a=a._originalNode),!r&&F(a)?n=U:!r&&_(a)?n=B:q(a)?n=G:z(a)?n=J:K(a)?n=Y:d.isElementNode(a)?n=Q:d.isTextNode(a)?n=V:d.isCommentNode(a)?n=ee:d.isDocumentTypeNode(a)&&(n=te),!n)throw console.error(a),Error(`Unable to serialize node ${a.nodeName||a.nodeType||a.type}`);n({...e,node:a})}}function F(e){return"application"===d.getTagName(e)}function _(e){return"route"===d.getTagName(e)}function B(e){k({...e,node:e.node})}function U({node:e,assetsStream:t,bodyStream:r,renderOptions:o,applicationPropPromises:n,propPromises:a,headerPromises:s}){const i=e.name,d=e.props||{},p=Promise.all(Object.keys(d).map((e=>{let t;return t=d[e]===b?a[e]||(a[e]=o.retrieveProp(e)):d[e],Promise.resolve(t).then((t=>[e,t]))}))).then((e=>{const t={};return e.forEach((([e,r])=>{t[e]=r})),t.name=i,t}));let c,u,m;n[i]=p,s[i]=o.retrieveApplicationHeaders({appName:i,propsPromise:p});try{if(c=o.renderApplication({appName:i,propsPromise:p}),"function"==typeof c.then)u=l(),m=l(),c.then((e=>{const t=X(i,e);u.add(t.contentStream),m.add(t.assetStream)}),(e=>{u.add(ne(i,e)),m.add(ne(i,e))}));else{const e=X(i,c);u=e.contentStream,m=e.assetStream}}catch(e){u=ne(i,e),m=ne(i,e)}t.add(m),r.add(re(`<div id="single-spa-application:${i}">`)),r.add(u),r.add(re("</div>"))}function X(e,t){let r,o;return t?(r=oe(t.content||t,e),o=oe(t.assets||"",e)):(r=ne(e,Error("returned nothing")),o=ne(e,Error("returned nothing"))),{contentStream:r,assetStream:o}}function q(e){return d.isElementNode(e)&&"ssl-router-content"===d.getTagName(e)}function G(e){const{renderOptions:t}=e,r=y(t.serverLayout.resolvedRoutes,t.urlPath);k({...e,node:{childNodes:r.routes}}),function({propPromises:e,bodyStream:t}){try{t.add(oe((async()=>{const t=(await Promise.all(Object.entries(e).map((([e,t])=>t.then((t=>[e,t])))))).reduce(((e,[t,r])=>(e[t]=r,e)),{});return`<script>window.singleSpaLayoutData = ${JSON.stringify({props:t})}<\/script>`})()))}catch(e){t.add(ne("Serialize layout props",e))}}(e)}function K(e){return d.isElementNode(e)&&"fragment"===d.getTagName(e)}function z(e){return d.isElementNode(e)&&"assets"===d.getTagName(e)}function Y({node:e,bodyStream:t,renderOptions:r}){const o=d.getAttrList(e).find((e=>"name"===e.name));if(!o.name)throw Error("<fragment> has unknown name");let n;try{n=oe(r.renderFragment(o.value),`Fragment ${o.value}`)}catch(e){n=ne(`Fragment ${o.name}`,e)}t.add(n)}function J({assetsStream:e,bodyStream:t}){t.add(e)}function Q(e){const{node:t,bodyStream:r}=e,o=d.getTagName(t),n=d.getNamespaceURI(t);if(r.add(re(`<${o}`)),function({node:e,bodyStream:t}){const r=d.getAttrList(e)||[];for(let e=0,o=r.length;e<o;e++){const o=r[e],n=Z(o.value,!0);let a;o.namespace?o.namespace===M.XML?a="xml:"+o.name:o.namespace===M.XMLNS?("xmlns"!==o.name&&(a="xmlns:"),a=o.name):a=o.namespace===M.XLINK?"xlink:"+o.name:o.prefix+":"+o.name:a=o.name,t.add(re(` ${a}="${n}"`))}}(e),r.add(re(">")),o!==L.AREA&&o!==L.BASE&&o!==L.BASEFONT&&o!==L.BGSOUND&&o!==L.BR&&o!==L.COL&&o!==L.EMBED&&o!==L.FRAME&&o!==L.HR&&o!==L.IMG&&o!==L.INPUT&&o!==L.KEYGEN&&o!==L.LINK&&o!==L.META&&o!==L.PARAM&&o!==L.SOURCE&&o!==L.TRACK&&o!==L.WBR){const a=o===L.TEMPLATE&&n===M.HTML?d.getTemplateContent(t):t,s=e.inRouterElement||"single-spa-router"===o;k({...e,node:a,inRouterElement:s}),r.add(re(`</${o}>`))}}function V({node:e,bodyStream:t}){const r=d.getTextNodeContent(e),o=d.getParentNode(e);let n=null;o&&d.isElementNode(o)&&(n=d.getTagName(o)),n===L.STYLE||n===L.SCRIPT||n===L.XMP||n===L.IFRAME||n===L.NOEMBED||n===L.NOFRAMES||n===L.PLAINTEXT||n===L.NOSCRIPT?t.add(re(r)):t.add(re(Z(r,!1)))}function Z(e,t){return e=e.replace(R,"&amp;").replace(I,"&nbsp;"),t?e.replace(W,"&quot;"):e.replace(j,"&lt;").replace(D,"&gt;")}function ee({node:e,bodyStream:t}){t.add(re(`\x3c!--${d.getCommentNodeContent(e)}--\x3e`))}function te({node:e,bodyStream:t}){const r=d.getDocumentTypeNodeName(e);t.add(re(`<${s.serializeContent(r,null,null)}>`))}function re(e){const t=new i({read(){}});return t.push(e),t.push(null),t}function oe(e,t){let r;if(e&&"function"==typeof e.then){const o=e;r=l(),o.then((e=>{r.add("string"==typeof e?re(e):e)}),(e=>{r.add(ne(t,e))}))}else r="string"==typeof e?re(e):e;return r}function ne(e,t){return console.error(`${e} failed to render.`),console.error(t),re("")}export{S as constructServerLayout,H as sendLayoutHTTPResponse};
